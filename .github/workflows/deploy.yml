name: Deploy

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: af-south-1

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
    
    - name: Terraform Init
      working-directory: ./infrastructure/terraform
      run: terraform init
    
    - name: Terraform Plan
      working-directory: ./infrastructure/terraform
      run: terraform plan -var="environment=staging" -out=tfplan
    
    - name: Terraform Apply
      if: github.event_name != 'pull_request'
      working-directory: ./infrastructure/terraform
      run: terraform apply -auto-approve tfplan

  deploy-production:
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
    
    - name: Terraform Init
      working-directory: ./infrastructure/terraform
      run: terraform init
    
    - name: Terraform Plan
      working-directory: ./infrastructure/terraform
      run: terraform plan -var="environment=production" -out=tfplan
    
    - name: Terraform Apply
      working-directory: ./infrastructure/terraform
      run: terraform apply -auto-approve tfplan
    
    - name: Run smoke tests
      run: |
        # Add smoke tests here
        echo "Running smoke tests..."
        # curl -f https://mentalhealth.ke/health || exit 1

