# AlertManager configuration for Mental Health Platform
global:
  # Resolve timeout for alerts
  resolve_timeout: 5m
  # Default notification configuration
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  discord_api_url: '${DISCORD_WEBHOOK_URL}'

# Templates for alert messages
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree
route:
  # Default receiver
  receiver: 'default'
  
  # Group alerts by these labels
  group_by: ['alertname', 'cluster', 'service']
  
  # Wait time before sending initial notification
  group_wait: 10s
  
  # Wait time before sending notification about new alerts added to a group
  group_interval: 10s
  
  # Minimum time between two notifications about the same group
  repeat_interval: 12h
  
  # Child routes
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-alerts'
      continue: true
      group_wait: 0s
      repeat_interval: 1h
    
    # Crisis detection alerts - highest priority
    - match:
        alertname: CrisisDetectionServiceDown
      receiver: 'crisis-alerts'
      continue: true
      group_wait: 0s
      repeat_interval: 30m
    
    # Database alerts
    - match:
        alertname: DatabaseConnectionFailure
      receiver: 'database-alerts'
      continue: true
      group_wait: 0s
      repeat_interval: 2h
    
    # Warning alerts - less urgent
    - match:
        severity: warning
      receiver: 'warning-alerts'
      continue: false
      group_wait: 30s
      repeat_interval: 6h

# Inhibition rules (suppress certain alerts when others are firing)
inhibit_rules:
  # Suppress warning alerts when critical alerts are firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']
  
  # Suppress all alerts when service is down
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['job']

# Receivers (notification channels)
receivers:
  # Default receiver - email
  - name: 'default'
    email_configs:
      - to: '${ALERT_EMAIL}'
        from: 'alertmanager@mentalhealth.ke'
        smarthost: 'smtp.gmail.com:587'
        auth_username: '${SMTP_USERNAME}'
        auth_password: '${SMTP_PASSWORD}'
        headers:
          Subject: 'Mental Health Platform Alert'
        html: |
          <h2>Alert: {{ .GroupLabels.alertname }}</h2>
          <p><strong>Status:</strong> {{ .Status }}</p>
          <p><strong>Service:</strong> {{ .GroupLabels.job }}</p>
          <p><strong>Description:</strong> {{ .CommonAnnotations.description }}</p>
          <hr>
          <p><small>Firing alerts: {{ len .Alerts }}</small></p>

  # Critical alerts - multiple channels
  - name: 'critical-alerts'
    email_configs:
      - to: '${ALERT_EMAIL}'
        from: 'alertmanager@mentalhealth.ke'
        smarthost: 'smtp.gmail.com:587'
        auth_username: '${SMTP_USERNAME}'
        auth_password: '${SMTP_PASSWORD}'
        headers:
          Subject: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: red;">üö® CRITICAL ALERT</h2>
          <h3>{{ .GroupLabels.alertname }}</h3>
          <p><strong>Service:</strong> {{ .GroupLabels.job }}</p>
          <p><strong>Description:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>Time:</strong> {{ .StartsAt }}</p>
    # Slack webhook (if configured)
    webhook_configs:
      - url: '${SLACK_WEBHOOK_URL}'
        send_resolved: true
        title: 'üö® Critical Alert: {{ .GroupLabels.alertname }}'
        text: '{{ .CommonAnnotations.description }}'
    # Discord webhook (if configured)
    webhook_configs:
      - url: '${DISCORD_WEBHOOK_URL}'
        send_resolved: true
        title: 'üö® Critical Alert: {{ .GroupLabels.alertname }}'
        text: '{{ .CommonAnnotations.description }}'

  # Crisis detection alerts - highest priority
  - name: 'crisis-alerts'
    email_configs:
      - to: '${CRISIS_ALERT_EMAIL}'
        from: 'alertmanager@mentalhealth.ke'
        smarthost: 'smtp.gmail.com:587'
        auth_username: '${SMTP_USERNAME}'
        auth_password: '${SMTP_PASSWORD}'
        headers:
          Subject: 'üö®üö® CRISIS DETECTION SERVICE DOWN üö®üö®'
        html: |
          <h1 style="color: red;">üö® CRISIS DETECTION SERVICE DOWN üö®</h1>
          <p><strong>This is a CRITICAL safety issue!</strong></p>
          <p>The crisis detection service is not responding. User safety may be compromised.</p>
          <p><strong>Time:</strong> {{ .StartsAt }}</p>
          <p><strong>Action Required:</strong> Investigate immediately and restore service.</p>
    webhook_configs:
      - url: '${SLACK_WEBHOOK_URL}'
        send_resolved: true
        title: 'üö®üö® CRISIS DETECTION SERVICE DOWN üö®üö®'
        text: 'The crisis detection service is not responding. User safety may be compromised.'
      - url: '${DISCORD_WEBHOOK_URL}'
        send_resolved: true
        title: 'üö®üö® CRISIS DETECTION SERVICE DOWN üö®üö®'
        text: 'The crisis detection service is not responding. User safety may be compromised.'

  # Database alerts
  - name: 'database-alerts'
    email_configs:
      - to: '${ALERT_EMAIL}'
        from: 'alertmanager@mentalhealth.ke'
        smarthost: 'smtp.gmail.com:587'
        auth_username: '${SMTP_USERNAME}'
        auth_password: '${SMTP_PASSWORD}'
        headers:
          Subject: '‚ö†Ô∏è Database Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2>‚ö†Ô∏è Database Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Description:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>Time:</strong> {{ .StartsAt }}</p>

  # Warning alerts
  - name: 'warning-alerts'
    email_configs:
      - to: '${ALERT_EMAIL}'
        from: 'alertmanager@mentalhealth.ke'
        smarthost: 'smtp.gmail.com:587'
        auth_username: '${SMTP_USERNAME}'
        auth_password: '${SMTP_PASSWORD}'
        headers:
          Subject: '‚ö†Ô∏è Warning: {{ .GroupLabels.alertname }}'
        html: |
          <h2>‚ö†Ô∏è Warning Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Service:</strong> {{ .GroupLabels.job }}</p>
          <p><strong>Description:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>Time:</strong> {{ .StartsAt }}</p>

